<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="AttendancePro‚Ñ¢ Dashboard - Enterprise Attendance Management" />
  <title>Dashboard | AttendancePro‚Ñ¢ Management System</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>

<body data-canmark="<%= canMark ? '1' : '0' %>">
  <div class="container">
    <div class="app-header">
      <h1>üìä ATTENDANCE DASHBOARD</h1>
    </div>

    <div class="nav-links" style="text-align: center; margin-bottom: 30px;">
      <a href="/change-password" style="margin-right: 15px;">
        üîë Change Password
      </a>
      <a href="/logout">
        üö™ Sign Out
      </a>
    </div>

    <% if (students && students.length) { %>
      <div class="dashboard-layout">
        <!-- Calendar Section -->
        <div class="calendar-section">
          <div class="calendar">
            <% const selectedDateObj=new Date(selectedDate || new Date().toISOString().slice(0,10)); const
              year=selectedDateObj.getFullYear(); const month=selectedDateObj.getMonth(); const firstDay=new Date(year,
              month, 1); const lastDay=new Date(year, month + 1, 0); const daysInMonth=lastDay.getDate(); const
              startingDayOfWeek=firstDay.getDay(); const monthName=firstDay.toLocaleString('default', { month: 'long' ,
              year: 'numeric' }); %>
              <div class="calendar-header">
                <div class="calendar-selectors">
                  <label>üìÖ Month:
                    <select id="monthSelect" onchange="navigateToDate()">
                      <% for (let m=0; m < 12; m++) { %>
                        <option value="<%= m %>" <%=m===month ? 'selected' : '' %>>
                          <%= new Date(year, m, 1).toLocaleString('default', { month: 'long' }) %>
                        </option>
                        <% } %>
                    </select>
                  </label>
                  <label>üìÜ Year:
                    <select id="yearSelect" onchange="navigateToDate()">
                      <% for (let y=year - 5; y <=year + 5; y++) { %>
                        <option value="<%= y %>" <%=y===year ? 'selected' : '' %>><%= y %>
                        </option>
                        <% } %>
                    </select>
                  </label>
                </div>
              </div>
              <table class="calendar-table">
                <thead>
                  <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                  </tr>
                </thead>
                <tbody>
                  <% let dateCounter=1; for (let week=0; week < 6; week++) { %>
                    <tr>
                      <% for (let dayOfWeek=0; dayOfWeek < 7; dayOfWeek++) { const cellIndex=week * 7 + dayOfWeek; const
                        dayNum=cellIndex - startingDayOfWeek + 1; if (dayNum> 0 && dayNum <= daysInMonth) { const
                          dateStr=year + '-' + String(month + 1).padStart(2, '0' ) + '-' +
                          String(dayNum).padStart(2, '0' ); const isSelected=dateStr===selectedDate; %>
                          <td><a href="?date=<%= dateStr %>" class="<%= isSelected ? 'selected-date' : '' %>">
                              <%= dayNum %>
                            </a></td>
                          <% } else { %>
                            <td class="empty"></td>
                            <% } } %>
                    </tr>
                    <% } %>
                </tbody>
              </table>
          </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
          <div class="summary-card">
            <h3>üìà Attendance Summary</h3>
            <p class="summary-date"><strong>Selected Date:</strong> <span id="summaryDate">
                <%= selectedDate %>
              </span></p>
            <div class="summary-stats">
              <div class="stat-box present-box">
                <div class="stat-label">‚úÖ Present</div>
                <div class="stat-count" id="presentCount">0</div>
              </div>
              <div class="stat-box absent-box">
                <div class="stat-label">‚ùå Absent</div>
                <div class="stat-count" id="absentCount">0</div>
              </div>
              <div class="stat-box total-box">
                <div class="stat-label">üë• Total</div>
                <div class="stat-count" id="totalCount">
                  <%= pagination.totalStudents %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Premium Report Export Section (Teachers Only) -->
      <% if (canMark) { %>
        <div class="report-export-section">
          <div class="report-card">
            <div class="report-header">
              <div class="report-icon">üìä</div>
              <div>
                <h3>Export Attendance Report</h3>
                <p>Download professional PDF report for any date range</p>
              </div>
            </div>
            <div class="report-form">
              <div class="date-range-picker">
                <div class="date-field">
                  <label for="reportStartDate">
                    <span class="date-label-icon">üìÖ</span> From Date
                  </label>
                  <input type="date" id="reportStartDate" class="date-input" />
                </div>
                <div class="date-separator">
                  <span>‚Üí</span>
                </div>
                <div class="date-field">
                  <label for="reportEndDate">
                    <span class="date-label-icon">üìÖ</span> To Date
                  </label>
                  <input type="date" id="reportEndDate" class="date-input" />
                </div>
              </div>
              <button type="button" id="exportBtn" class="export-btn" onclick="exportAttendanceReport()">
                <span class="export-btn-content">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                  </svg>
                  Download PDF Report
                </span>
              </button>
            </div>
            <div class="report-info">
              <div class="info-item">
                <span class="info-icon">‚úÖ</span>
                <span>Includes all students' attendance summary</span>
              </div>
              <div class="info-item">
                <span class="info-icon">üìà</span>
                <span>Attendance percentage calculated automatically</span>
              </div>
              <div class="info-item">
                <span class="info-icon">üìÑ</span>
                <span>Professional PDF format ready for printing</span>
              </div>
            </div>
          </div>
        </div>
        <% } %>

          <!-- Pagination Info -->
          <% if (pagination && pagination.totalStudents> 0) { %>
            <div class="pagination-info">
              <p>üìã Showing students <strong>
                  <%= pagination.startIndex %>
                </strong> to <strong>
                  <%= pagination.endIndex %>
                </strong> of <strong>
                  <%= pagination.totalStudents %>
                </strong> total</p>
            </div>
            <% } %>

              <!-- Pagination Controls -->
              <% if (pagination && pagination.totalPages> 1) { %>
                <div class="pagination-controls">
                  <% const currentPage=pagination.currentPage; const totalPages=pagination.totalPages; const
                    currentDate=selectedDate || new Date().toISOString().slice(0,10); %>
                    <% if (currentPage> 1) { %>
                      <a href="?date=<%= currentDate %>&page=<%= currentPage - 1 %>" class="pagination-btn">‚Üê
                        Previous</a>
                      <% } else { %>
                        <span class="pagination-btn disabled">‚Üê Previous</span>
                        <% } %>

                          <span class="pagination-current">Page <%= currentPage %> of <%= totalPages %></span>

                          <% if (currentPage < totalPages) { %>
                            <a href="?date=<%= currentDate %>&page=<%= currentPage + 1 %>" class="pagination-btn">Next
                              ‚Üí</a>
                            <% } else { %>
                              <span class="pagination-btn disabled">Next ‚Üí</span>
                              <% } %>
                </div>
                <% } %>

                  <form method="post" action="/teacher/mark" id="attendanceForm">
                    <input type="hidden" name="date"
                      value="<%= selectedDate || new Date().toISOString().slice(0,10) %>" />
                    <table>
                      <thead>
                        <tr>
                          <th>üë§ Student Name</th>
                          <th>üìä Attendance Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% students.forEach((s, index)=> { %>
                          <tr style="animation-delay: <%= index * 0.05 %>s">
                            <td><a href="#" class="student-name" data-student-id="<%= s.student_id %>"
                                data-student-name="<%= s.name %>"
                                data-status="<%= (attendanceMap && attendanceMap[s.student_id]) || '' %>">
                                <%= s.name %>
                              </a></td>
                            <td>
                              <% const status=(attendanceMap && attendanceMap[s.student_id]); %>
                                <label><input type="radio" name="statuses[<%= s.student_id %>]" value="present"
                                    <%=status==='present' ? 'checked' : '' %>
                                  <%= canMark ? '' : 'disabled' %>/> Present
                                </label>
                                <label><input type="radio" name="statuses[<%= s.student_id %>]" value="absent"
                                    <%=status==='absent' ? 'checked' : '' %>
                                  <%= canMark ? '' : 'disabled' %>/> Absent
                                </label>
                            </td>
                          </tr>
                          <% }) %>
                      </tbody>
                    </table>
                    <% if (canMark) { %>
                      <div style="margin-top: 25px; text-align: center;">
                        <button type="submit" id="saveBtn">
                          <span style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                            üíæ Save Attendance
                          </span>
                        </button>
                      </div>
                      <% } else { %>
                        <div
                          style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; text-align: center;">
                          <p style="color: #64748b; margin: 0;">üîí <em>Read-only view ‚Äî Sign in as a teacher to mark
                              attendance.</em></p>
                        </div>
                        <% } %>
                  </form>

                  <!-- Pagination Controls (Bottom) -->
                  <% if (pagination && pagination.totalPages> 1) { %>
                    <div class="pagination-controls">
                      <% const currentPage=pagination.currentPage; const totalPages=pagination.totalPages; const
                        currentDate=selectedDate || new Date().toISOString().slice(0,10); %>
                        <% if (currentPage> 1) { %>
                          <a href="?date=<%= currentDate %>&page=<%= currentPage - 1 %>" class="pagination-btn">‚Üê
                            Previous</a>
                          <% } else { %>
                            <span class="pagination-btn disabled">‚Üê Previous</span>
                            <% } %>

                              <span class="pagination-current">Page <%= currentPage %> of <%= totalPages %></span>

                              <% if (currentPage < totalPages) { %>
                                <a href="?date=<%= currentDate %>&page=<%= currentPage + 1 %>"
                                  class="pagination-btn">Next
                                  ‚Üí</a>
                                <% } else { %>
                                  <span class="pagination-btn disabled">Next ‚Üí</span>
                                  <% } %>
                    </div>
                    <% } %>
                      <% } else { %>
                        <div
                          style="text-align: center; padding: 60px 30px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                          <div style="font-size: 80px; margin-bottom: 20px;">üìö</div>
                          <h2 style="color: #334155; margin-bottom: 15px;">No Students Available</h2>
                          <p style="color: #64748b;">Please upload students via the Admin Dashboard to get started.</p>
                        </div>
                        <% } %>

                          <div class="app-footer">
                            <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                              <span style="font-size: 1.1rem;">üè´ AttendancePro‚Ñ¢ Management System</span>
                              <span style="opacity: 0.7; font-size: 0.85rem;">Designed for Teacher Pallavi Pradhan | ¬©
                                2026
                                All Rights Reserved</span>
                            </div>
                          </div>
  </div>

  <!-- Modal for Monthly Summary -->
  <div id="monthlySummaryModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2 id="modalStudentName"></h2>
      <h3 id="modalMonth"></h3>
      <div class="modal-stats">
        <div class="modal-stat-box present-box">
          <div class="stat-label">‚úÖ Present</div>
          <div class="stat-count" id="modalPresentCount">0</div>
        </div>
        <div class="modal-stat-box absent-box">
          <div class="stat-label">‚ùå Absent</div>
          <div class="stat-count" id="modalAbsentCount">0</div>
        </div>
        <div class="modal-stat-box total-box">
          <div class="stat-label">üìÖ Total Days</div>
          <div class="stat-count" id="modalTotalMarked">0</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Navigate to selected month/year
    function navigateToDate() {
      const monthSelect = document.getElementById('monthSelect');
      const yearSelect = document.getElementById('yearSelect');
      const month = parseInt(monthSelect.value);
      const year = parseInt(yearSelect.value);
      const date = year + '-' + String(month + 1).padStart(2, '0') + '-01';
      window.location.href = '?date=' + date;
    }

    // Update attendance summary counts
    function updateSummary() {
      const presentRadios = document.querySelectorAll('input[name^="statuses["][value="present"]:checked');
      const absentRadios = document.querySelectorAll('input[name^="statuses["][value="absent"]:checked');
      const presentCount = presentRadios.length;
      const absentCount = absentRadios.length;

      document.getElementById('presentCount').textContent = presentCount;
      document.getElementById('absentCount').textContent = absentCount;
    }

    // Show monthly summary modal
    function showMonthlySummaryModal(data) {
      const modal = document.getElementById('monthlySummaryModal');
      document.getElementById('modalStudentName').textContent = data.student.name;
      document.getElementById('modalMonth').textContent = data.month;
      document.getElementById('modalPresentCount').textContent = data.summary.present;
      document.getElementById('modalAbsentCount').textContent = data.summary.absent;
      document.getElementById('modalTotalMarked').textContent = data.summary.totalMarked;
      modal.style.display = 'block';
    }

    // clicking a student name shows monthly summary (teachers only)
    document.addEventListener('DOMContentLoaded', function () {
      const selectedDate = '<%= selectedDate || new Date().toISOString().slice(0,10) %>';
      document.getElementById('summaryDate').textContent = selectedDate;
      const canMark = document.body.dataset.canmark === '1';

      // Initial summary update
      updateSummary();

      // Setup modal close functionality
      const modal = document.getElementById('monthlySummaryModal');
      const closeBtn = document.querySelector('.modal-close');
      closeBtn.onclick = function () {
        modal.style.display = 'none';
      };
      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      };

      document.querySelectorAll('.student-name').forEach(a => {
        a.addEventListener('click', async function (e) {
          e.preventDefault();

          const studentId = this.dataset.studentId;
          const name = this.dataset.studentName;

          if (!canMark) {
            // show current status for non-teachers
            const status = this.dataset.status || 'no record';
            alert(name + ' on ' + selectedDate + ': ' + (status || 'no record'));
            return;
          }

          // For teachers: Show monthly summary in a modal
          try {
            const response = await fetch(`/api/student-monthly-summary?studentId=${encodeURIComponent(studentId)}&date=${selectedDate}`);
            if (!response.ok) throw new Error('Failed to fetch summary');

            const data = await response.json();

            // Show modal with monthly summary
            showMonthlySummaryModal(data);
          } catch (err) {
            console.error('Error fetching monthly summary:', err);
            alert('Error loading monthly summary');
          }
        });
      });

      // Radio button change listener for updating summary counts
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function () {
          updateSummary();
        });
      });

      // Form submit with loading state
      const form = document.getElementById('attendanceForm');
      const saveBtn = document.getElementById('saveBtn');
      if (form && saveBtn) {
        form.addEventListener('submit', function () {
          saveBtn.innerHTML = '<span style="display: flex; align-items: center; justify-content: center; gap: 10px;">‚è≥ Saving...</span>';
          saveBtn.disabled = true;
        });
      }

      // Set default dates for report export
      const reportStartDate = document.getElementById('reportStartDate');
      const reportEndDate = document.getElementById('reportEndDate');
      if (reportStartDate && reportEndDate) {
        // Default to current month
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        reportStartDate.value = firstDay.toISOString().slice(0, 10);
        reportEndDate.value = lastDay.toISOString().slice(0, 10);
      }
    });

    // Export Attendance Report Function
    function exportAttendanceReport() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      const exportBtn = document.getElementById('exportBtn');

      if (!startDate || !endDate) {
        alert('‚ö†Ô∏è Please select both start and end dates');
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        alert('‚ö†Ô∏è Start date cannot be after end date');
        return;
      }

      // Show loading state
      const originalContent = exportBtn.innerHTML;
      exportBtn.innerHTML = '<span class="export-btn-content">‚è≥ Generating Report...</span>';
      exportBtn.disabled = true;

      // Trigger download
      const url = `/api/export-attendance?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error('Export failed');
          return response.blob();
        })
        .then(blob => {
          // Create download link
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = `Attendance_Report_${startDate}_to_${endDate}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(downloadUrl);
          a.remove();

          // Show success
          exportBtn.innerHTML = '<span class="export-btn-content">‚úÖ Downloaded!</span>';
          setTimeout(() => {
            exportBtn.innerHTML = originalContent;
            exportBtn.disabled = false;
          }, 2000);
        })
        .catch(error => {
          console.error('Export error:', error);
          alert('‚ùå Error generating report. Please try again.');
          exportBtn.innerHTML = originalContent;
          exportBtn.disabled = false;
        });
    }
  </script>
</body>

</html>